---
title: "Sensitivity Analyses"
author: "Devin Gamble"
date: "5/13/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r warning = FALSE, message = FALSE, echo = FALSE}
#Load Packages
library(car)
library(tidyverse)
library(broom)
library(here)
library(ggplot2)
library(visreg)
library(jtools)
library(interactions)
```


## Objective:  
#### Determine how sensitivity to different climate variables, for different seasons/months, and for long-term vs anomalouse climate varies  
- through time  
- Across space (lat, long, elev)  
- by climate region  

```{r message = FALSE, warning = FALSE}
#Load Data

nemo_df2 <- read_csv(here::here("data_cleaning", "nemo_full_1901_2019.csv")) %>%  
  mutate(error_bin = as_factor(error_bin)) #Should this be ordered? #Combined specimen & climate data from 1901-2019
#1677 obs, 1251 columns

nemo_df1 <- read_csv(here::here("data_cleaning", "nemo_full_1861_2019.csv")) #Combined data for all years
#1764 obs, 1251 columns


#Set contrasts
options(contrasts = c("contr.sum", "contr.poly"))
```


## Identify Sensitivity to different climatic variables  
* See 'EDA2.Rmd' for exploration of different models.



*To-Do*  
- Fix & clean up models describing sensitivity to different aspects of local climate  
- Calculate new seasonal windows of climate parameters (and save to csv)  
- Statistically compare slope estimates of climate parameters on DOY to select the most influential parameters  
- Add in PI as a covariate in models  

<br>  



May also consider:  
- NFFD, bFFP, CMD, RH, DD5, MCMT (see EDA2)


### Annual Conditions  

 
```{r message = FALSE, warning = FALSE}
#100Y

ann_clim1 <- lm(DOY ~ MAT_100Y + MAP_100Y, data = nemo_df2)
ann_clim2 <- lm(DOY ~ MAT_100Y + MAP_100Y + elev_m, data = nemo_df2)
ann_clim3 <- lm(DOY ~ MAT_100Y + MAP_100Y + elev_m + long, data = nemo_df2)
ann_clim4 <- lm(DOY ~ MAT_100Y + MAP_100Y + elev_m + long + year, data = nemo_df2) #Best, though adding year doesn't change much
#No interactions

summary(ann_clim1)
summary(ann_clim2)
summary(ann_clim3)
summary(ann_clim4)
summ(ann_clim4, scale = TRUE, vif = TRUE)
#Controlling for elevation severely reduces the effect of MAT (ns)
#Controlling for elev and long - the effect of temperature returns but is still quite small

summ(ann_clim3, vif = TRUE) #VIF for long, elev, MAP, MAT is high

visreg(ann_clim1, "MAT_100Y", xlab = "MAT (1901-2000)", points = list(col = "#404040"))
visreg(ann_clim1, "MAP_100Y", xlab = "MAP (1901-2000)", points = list(col = "#404040"))

visreg(ann_clim3, "MAT_100Y", xlab = "MAT (1901-2000)", points = list(col = "#404040"))
visreg(ann_clim3, "MAP_100Y", xlab = "MAP (1901-2000)", points = list(col = "#404040"))

visreg(ann_clim4, "MAT_100Y", xlab = "MAT (1901-2000)", points = list(col = "#333333"), gg = TRUE) + theme_apa()
ggsave(here::here("analyses", "figs1", "MAT_100Y_phensen.png"), height = 4, width = 6)
visreg(ann_clim4, "MAP_100Y", xlab = "MAP (1901-2000)", points = list(col = "#333333"), gg = TRUE) + theme_apa()
ggsave(here::here("analyses", "figs1", "MAP_100Y_phensen.png"), height = 4, width = 6)

##Plots same as those created in `bias_error.Rmd'

```


```{r message = FALSE, warning = FALSE, echo = FALSE, eval = FALSE}
#redudant with EDA2 code
#plots
#Non-climatic
#scaled: means = 0 and var = 1
#Compare relative effect of each variable

nonclim1 <- lm(DOY ~ scale(elev_m) + scale(long) + scale(year), data = nemo_df2)
summary(nonclim1)

visreg(nonclim1, xvar = "elev_m", xlab = "Elevation (m)", points = list(col = "#404040")) 
visreg(nonclim1, "year", xlab = "Year", points = list(col = "#404040"))
#visreg(nonclim1, "lat", xlab = "Latitude", points = list(col = "#404040"))
visreg(nonclim1, "long", xlab = "Longitude", points = list(col = "#404040"))
```


The relationship b/w DOY and MAT weakens as the model is parameterized, while the estimate of MAP strengthens. MAP appears to be driving variation in DOY. There were no significant interactions between any covariates.  
While MAT still appears to advance DOY, controlling for geography seems to explain a good deal of this variation (over a 100-yr avg). Examining seasonal climate and anomalies should shed more light on this.  


Note: Everything at the annual scale for 100Y averages is strongly correlated (see EDA2.Rmd). Refer to `ann_clim3` model above (controls for elev_m and long).  

<br>  



## Anomalous Long-term Climate Variables  

**Annual Variables**  
```{r message = FALSE, warning = FALSE}
#100Y

anom_clim1 <- lm(DOY ~ MAT_A + MAP_A, data = nemo_df2)
anom_clim2 <- lm(DOY ~ MAT_A + MAP_A + elev_m, data = nemo_df2)
anom_clim3 <- lm(DOY ~ MAT_A + MAP_A + elev_m + long, data = nemo_df2)
anom_clim4 <- lm(DOY ~ MAT_A + MAP_A + elev_m + long + year, data = nemo_df2) #Best, though adding year doesn't change much
#No interactions

summary(anom_clim1)
summary(anom_clim2)
summary(anom_clim3)
summary(anom_clim4)
summ(anom_clim4, scale = TRUE, vif = TRUE)
#Controlling for elevation severely reduces the effect of MAT (ns)
#Controlling for elev and long - the effect of temperature returns but is still quite small

summ(anom_clim3, vif = TRUE) #VIF for long, elev, MAP, MAT is high

visreg(anom_clim1, "MAT_A", xlab = "MAT (anomaly)", points = list(col = "#404040"))
visreg(anom_clim1, "MAP_A", xlab = "MAP (anomaly)", points = list(col = "#404040"))

visreg(anom_clim3, "MAT_A", xlab = "MAT (anomaly)", points = list(col = "#404040"))
visreg(anom_clim3, "MAP_A", xlab = "MAP (anomaly)", points = list(col = "#404040"))

visreg(anom_clim4, "MAT_A", xlab = "MAT (anomaly)", points = list(col = "#333333"), gg = TRUE) + theme_apa() +
  geom_vline(xintercept = 0, lty = 2)
ggsave(here::here("analyses", "figs1", "MAT_A_phensen.png"), height = 4, width = 6)
visreg(anom_clim4, "MAP_A", xlab = "MAP (anomaly)", points = list(col = "#333333"), gg = TRUE) + theme_apa() +
  geom_vline(xintercept = 0, lty = 2)
ggsave(here::here("analyses", "figs1", "MAP_A_phensen.png"), height = 4, width = 6)

##Plots same as those created in `bias_error.Rmd'

```



### Seasonal Conditions - Long-term

For Seasonal variables, examine models with:
- Tmin & Tave (Winter, spring) [No Tmax]  
- PPT (Winter, Spring, Summer)  


May also consider  
- DD > 5 (spring and winter)   
- DD > 18 (spring and summer)  
- CMD (winter, spring, summer)? RH?  
<br>  


From 'EDA2.Rmd', Both Spring temperature and precipitation (from 100Y averages) appeared to be the most influential on DOY. Tave had a higher R2 and Beta than Tmin for spring temps...  

**Winter Conditions**

```{r message = FALSE, warning = FALSE}

#Winter Conditions
sz_wt1 <- lm(DOY ~ Tmin_wt_100Y + PPT_wt_100Y, data = nemo_df2)
#summary(sz_wt1)

sz_wt1c <- lm(DOY ~ Tmin_wt_100Y + PPT_wt_100Y + elev_m + long + year, data = nemo_df2)
summary(sz_wt1c)

#visreg(sz_wt1, xvar = "PPT_wt_100Y", xlab = "PPT (winter)", points = list(col = "#404040"))
#visreg(sz_wt1, xvar = "Tmin_wt_100Y", xlab = "Tmin (winter)", points = list(col = "#404040"))

visreg(sz_wt1c, xvar = "PPT_wt_100Y", xlab = "PPT (winter)", points = list(col = "#404040"))
visreg(sz_wt1c, xvar = "Tmin_wt_100Y", xlab = "Tmin (winter)", points = list(col = "#404040"))


sz_wt1cave <- lm(DOY ~ Tave_wt_100Y + PPT_wt_100Y + elev_m + long + year, data = nemo_df2)
summary(sz_wt1cave) #These have low R2 and high SE, plus estimates are crazy  


sz_wt1_int <- lm(DOY ~ PPT_wt_100Y*Tmin_wt_100Y + elev_m + long + year, data = nemo_df2) #NS w/ elev + long
#summary(sz_wt1_int) #R2 - 0.18, interaction B = -1.25     #Tmin more significant, removed Tave


visreg(sz_wt1_int, xvar = "PPT_wt_100Y", xlab = "PPT (winter)", points = list(col = "#404040"))
visreg(sz_wt1_int, xvar = "Tmin_wt_100Y", xlab = "Tmin (winter)", points = list(col = "#404040"))

johnson_neyman(sz_wt1_int, pred = "Tmin_wt_100Y", modx = "PPT_wt_100Y")
interact_plot(sz_wt1_int, pred = "Tmin_wt_100Y", modx = "PPT_wt_100Y")
interact_plot(sz_wt1_int, pred = "PPT_wt_100Y", modx = "Tmin_wt_100Y") + theme_bw()


AIC(sz_wt1c, sz_wt1cave, sz_wt1_int)
#Tmin model has lower AIC than Tave model
#Tmax N.S.

lapply(list(sz_wt1c, sz_wt1cave, sz_wt1_int), summ, vif = TRUE, scale = TRUE)

```


Controlling for geographic location (long and elev) [not shown], the interaction between Tmin_wt and PPT_wt disappears. Including year as a covariate slightly improves $R^2$ and Tmin estimate.  


**Spring Conditions**

```{r message = FALSE, warning = FALSE}
#Spring Conditions
#sz_sp1 <- lm(DOY ~ Tmin_sp_100Y + PPT_sp_100Y, data = nemo_df2)
#summary(sz_sp1)
#sz_sp1.1 <- lm(DOY ~ Tave_sp_100Y + PPT_sp_100Y, data = nemo_df2)
#summary(sz_sp1)
#visreg(sz_sp1, xvar = "PPT_sp_100Y", xlab = "PPT (spring)", points = list(col = "#404040"))
#visreg(sz_sp1, xvar = "Tmin_sp_100Y", xlab = "Tmin (spring)", points = list(col = "#404040"))


sz_sp1c <- lm(DOY ~ Tmin_sp_100Y + PPT_sp_100Y + elev_m + long + year, data = nemo_df2)
summary(sz_sp1c)

sz_sp1cave <- lm(DOY ~ Tave_sp_100Y + PPT_sp_100Y + elev_m + long + year, data = nemo_df2)
summary(sz_sp1c)

visreg(sz_sp1c, xvar = "PPT_sp_100Y", xlab = "PPT (spring)", points = list(col = "#404040"))
visreg(sz_sp1c, xvar = "Tmin_sp_100Y", xlab = "Tmin (spring)", points = list(col = "#404040"))


#Interactions
sz_sp1_int <- lm(DOY ~ Tmin_sp_100Y*PPT_sp_100Y + elev_m + long + year, data = nemo_df2)
summary(sz_sp1_int) #Interaction with Tmin more significant than Tave, NS with elev and long

johnson_neyman(sz_sp1_int, pred = "Tmin_sp_100Y", modx = "PPT_sp_100Y")
interact_plot(sz_sp1_int, pred = "Tmin_sp_100Y", modx = "PPT_sp_100Y", x.label = "Tmin (spring)", legend.main = "PPT (spring)") + theme_bw()
interact_plot(sz_sp1_int, pred = "PPT_sp_100Y", modx = "Tmin_sp_100Y", x.label = "PPT (spring)", legend.main = "Tmin (spring)") + theme_bw()
#Swapping Tave for DD>5: similar but much weaker. DD v correlated to Tave


AIC(sz_sp1c, sz_sp1cave, sz_sp1_int)
#Non-interaction, Tmin model most supported

lapply(list(sz_sp1c, sz_sp1cave, sz_sp1_int), summ, vif = TRUE, scale = TRUE)

```



Interaction term becomes marginally significant. Removing it, we see results similar to the above winter 'standard' model - advancing effect of Tmin (+ year), delaying effect of PPT (+ long, elevation)

Tmin appears to explain more variation than Tave *in its interaction with PPT_sp*. Interaction is stronger with Tmin than Tave and PPT. Better $R^2$ and AIC with Tmin model (no interaction).  

[Summer conditions are likely not biologically important in the phenology of N menziesii, patterns due to correlation]
```{r message = FALSE, warning = FALSE, echo = FALSE, eval = FALSE}
#Summer Conditions
sz_clim3 <- lm(DOY ~ Tmin_sm_100Y + PPT_sm_100Y, data = nemo_df2)
summary(sz_clim3)
sz_clim3.1 <- lm(DOY ~ Tave_sm_100Y + PPT_sm_100Y, data = nemo_df2)
summary(sz_clim3.1)
sz_clim3.2 <- lm(DOY ~ Tmin_sm_100Y +  PPT_sm_100Y + Tmin_sm_100Y*PPT_sm_100Y, data = nemo_df2)
#summary(stepAIC(sz_clim3.2, direction = "both"))
#Looks like Summer PPT has the largest effect, with Tmin marginally advancing DOY. No interaction
visreg(sz_clim3.2, xvar = "PPT_sm_100Y", xlab = "PPT (summer)", points = list(col = "#404040"))
```


**Winter x Spring Conditions**

```{r message = FALSE, warning = FALSE, results = 'hide'}
sz_wt_sp1 <- lm(DOY ~ Tmin_sp_100Y + PPT_wt_100Y + elev_m + long + year, data = nemo_df2)
summary(sz_wt_sp1)
sz_wt_sp1ave <- lm(DOY ~ Tave_sp_100Y + PPT_wt_100Y + elev_m + long + year, data = nemo_df2)
summary(sz_wt_sp1ave)

sz_wt_sp2 <- lm(DOY ~ Tmin_wt_100Y + PPT_sp_100Y + elev_m + long + year, data = nemo_df2)
summary(sz_wt_sp2)
sz_wt_sp2ave <- lm(DOY ~ Tave_wt_100Y + PPT_sp_100Y + elev_m + long + year, data = nemo_df2)
summary(sz_wt_sp2ave)

sz_wt_sp1_int <- lm(DOY ~ Tmin_sp_100Y + PPT_wt_100Y + Tmin_sp_100Y*PPT_wt_100Y + elev_m + long + year, data = nemo_df2)
summary(sz_wt_sp1_int)

sz_wt_sp2_int <- lm(DOY ~ Tmin_wt_100Y + PPT_sp_100Y + Tmin_wt_100Y*PPT_sp_100Y + elev_m + long + year, data = nemo_df2)
summary(sz_wt_sp2_int)



johnson_neyman(sz_wt_sp1_int, pred = "Tmin_sp_100Y", modx = "PPT_wt_100Y")
interact_plot(sz_wt_sp1_int, pred = "Tmin_sp_100Y", modx = "PPT_wt_100Y", x.label = "Tmin (spring)", legend.main = "PPT (winter)") + theme_bw()
ggsave(here::here("analyses", "figs1", "intplot_wtP_spT1_100Y.png"), height = 4, width = 6)

johnson_neyman(sz_wt_sp1_int, pred = "PPT_wt_100Y", modx = "Tmin_sp_100Y")
interact_plot(sz_wt_sp1_int, pred = "PPT_wt_100Y", modx = "Tmin_sp_100Y", x.label = "PPT (winter)", legend.main = "Tmin (spring)") + theme_bw()
ggsave(here::here("analyses", "figs1", "intplot_wtP_spT2_100Y.png"), height = 4, width = 6)



AIC(sz_wt_sp1, sz_wt_sp2, sz_wt_sp1ave, sz_wt_sp2ave, sz_wt_sp1_int, sz_wt_sp2_int) #Reg, Tave, interactions

#Non-int Tmin_wt & PPT_sp has lowest AIC/most support **(sz_wt_sp2)**. 

#Lower AIC support but Tmin_sp & PPT_wt interaction was significant **(sz_wt_sp1_int)**

lapply(list(sz_wt_sp1, sz_wt_sp2, sz_wt_sp1ave, sz_wt_sp2ave, sz_wt_sp1_int, sz_wt_sp2_int), summ, vif = TRUE, scale = TRUE)

```




#### Comparing Models  


**Compare supported seasonal models**  

```{r}
library(MASS) #Crashes other functions, only load for use
#Additive only
AIC(ann_clim4, sz_wt1c, sz_sp1c, sz_wt_sp2)

#sz_sp1c most supported, only slightly better than Tmin_wt & PPT_sp
#Suggests that PPT_sp is a major determining factor of DOY!


#With int
AIC(sz_wt1c, sz_sp1c, sz_sp1_int, sz_wt_sp2, sz_wt_sp1_int)
#sz_sp1c most supported and significant #sz_sp1_int NS, but more supported (NS, AIC < 2) than non-int


#StepAIC model & evaluation
sz_comb_mAIC <- lm(DOY ~ Tmin_wt_100Y + Tmin_sp_100Y + PPT_wt_100Y + PPT_sp_100Y + elev_m + long + year, data = nemo_df2)
stepAIC(sz_comb_mAIC)
#Additive: Prefers T_sp & PPT_sp the most!

```
`sz_sp1c` was the model most supported by AIC comparison (and stepAIC). This suggests that both Spring PPT and Tmin are major determinants of DOY. However, the combo model with Winter Tmin and Spring PPT was significant, although less supported.



**Plots** - Only additive models included
```{r warning = FALSE, message = FALSE, echo = FALSE}
#Center & Scale Estimates to make comparisons

#Just Seasonal Variables
plot_summs(sz_wt1c, sz_sp1c, sz_wt_sp2, model.names = c("Winter", "Spring", "Wt_T & Sp_PPT"), coefs = c("Tmin_wt_100Y", "Tmin_sp_100Y", "PPT_wt_100Y", "PPT_sp_100Y"), inner_ci_level = 0.8, scale = TRUE) +
  theme_bw()#including covariates

#Seasonal & Annual Variables
plot_summs(ann_clim4, sz_wt1c, sz_sp1c, sz_wt_sp2, model.names = c("MAT/P", "Winter", "Spring", "Wt_T & Sp_PPT"), coefs = c("MAT_100Y", "MAP_100Y", "Tmin_wt_100Y", "Tmin_sp_100Y", "PPT_wt_100Y", "PPT_sp_100Y"), inner_ci_level = 0.8, scale = TRUE) +
  theme_bw()

#Without mixed-season model
plot_summs(ann_clim4, sz_wt1c, sz_sp1c, model.names = c("MAT/P", "Winter", "Spring"), coefs = c("MAT_100Y", "MAP_100Y", "Tmin_wt_100Y", "Tmin_sp_100Y", "PPT_wt_100Y", "PPT_sp_100Y"), inner_ci_level = 0.8, scale = TRUE) +
  theme_bw()

ggsave(here::here("analyses", "figs1", "plot_summs_An_wt_sp_100Y.png"), height = 4, width = 6)

#Centering only - leads to same relative positioning of effect sizes, just different magnitudes/abs values

```



### Seasonal Conditions - Anomalies

**Winter Conditions**

```{r message = FALSE, warning = FALSE}
sz_wt1A <- lm(DOY ~ Tmin_wt_A + PPT_wt_A + elev_m + long + year, data = nemo_df2)
summary(sz_wt1A)
#visreg(sz_wt1A, xvar = "PPT_wt_A", xlab = "PPT (winter)", points = list(col = "#404040"))
#visreg(sz_wt1A, xvar = "Tmin_wt_A", xlab = "Tmin (winter)", points = list(col = "#404040"))


sz_wt1caveA <- lm(DOY ~ Tave_wt_A + PPT_wt_A + elev_m + long + year, data = nemo_df2)
summary(sz_wt1caveA) 

sz_wt1A_int <- lm(DOY ~ PPT_wt_A*Tmin_wt_A + elev_m + long + year, data = nemo_df2)
summary(sz_wt1A_int) #NS


AIC(sz_wt1A, sz_wt1caveA, sz_wt1A_int)
#Tmin model has lowest AIC 


lapply(list(sz_wt1A, sz_wt1caveA, sz_wt1A_int), summ, vif = TRUE, scale = TRUE)

```

Use additive model: sz_wt1A


**Spring Conditions**
```{r message = FALSE, warning = FALSE}
sz_sp1A <- lm(DOY ~ Tmin_sp_A + PPT_sp_A + elev_m + long + year, data = nemo_df2)
summary(sz_sp1A)
#visreg(sz_sp1A, xvar = "PPT_sp_A", xlab = "PPT (winter)", points = list(col = "#404040"))
#visreg(sz_sp1A, xvar = "Tmin_sp_A", xlab = "Tmin (winter)", points = list(col = "#404040"))


sz_sp1caveA <- lm(DOY ~ Tave_sp_A + PPT_sp_A + elev_m + long + year, data = nemo_df2)
summary(sz_sp1caveA) 
sz_sp1cmaxA <- lm(DOY ~ Tmax_sp_A + PPT_sp_A + elev_m + long + year, data = nemo_df2)
summary(sz_sp1cmaxA) 


sz_sp1A_int <- lm(DOY ~ PPT_sp_A*Tmin_sp_A + elev_m + long + year, data = nemo_df2)
summary(sz_sp1A_int) #NS, but similar p value as in long-term model
#Int w/ Tmax also NS


AIC(sz_sp1A, sz_sp1caveA, sz_sp1cmaxA, sz_sp1A_int)
#Tmax model having the most support (followed by Tave) for spring!!!


lapply(list(sz_sp1A, sz_sp1caveA, sz_sp1cmaxA, sz_sp1A_int), summ, vif = TRUE, scale = TRUE)
#Tmax_sp_A has the largest coeff, followed by Tave_sp_A has larger coefficient than Tmin

```

Use Model: sz_sp1cmaxA (followed by: sz_sp1caveA, sz_sp1A)

Temperature: Tmin_A is more influential in the winter, Tmax_A more important in the spring

**Winter x Spring conditions**  
```{r}
#sz_wt_sp1A <- lm(DOY ~ Tmin_sp_A + PPT_wt_A + elev_m + long + year, data = nemo_df2)
#summary(sz_wt_sp1A)
#sz_wt_sp1Aave <- lm(DOY ~ Tave_sp_A + PPT_wt_A + elev_m + long + year, data = nemo_df2)
#summary(sz_wt_sp1Aave)
sz_wt_sp1Amax <- lm(DOY ~ Tmax_sp_A + PPT_wt_A + elev_m + long + year, data = nemo_df2) #use this Tmax_sp, highest R2, lowest AIC of the 3
summary(sz_wt_sp1Amax)


sz_wt_sp2A <- lm(DOY ~ Tmin_wt_A + PPT_sp_A + elev_m + long + year, data = nemo_df2)#Use this: Tmin_wt, highest R2, lowest AIC
summary(sz_wt_sp2A)
#sz_wt_sp2Aave <- lm(DOY ~ Tave_wt_A + PPT_sp_A + elev_m + long + year, data = nemo_df2)
#summary(sz_wt_sp2Aave)
#sz_wt_sp2Amax <- lm(DOY ~ Tmax_wt_A + PPT_sp_A + elev_m + long + year, data = nemo_df2)
#summary(sz_wt_sp2Amax)


#Interactions
sz_wt_sp1_intA <- lm(DOY ~ Tmin_wt_A + PPT_sp_A + Tmin_wt_A*PPT_sp_A + elev_m + long + year, data = nemo_df2)
#summary(sz_wt_sp1_intA)
sz_wt_sp2_intA <- lm(DOY ~ Tmax_sp_A + PPT_wt_A + Tmax_sp_A*PPT_wt_A + elev_m + long + year, data = nemo_df2)
#summary(sz_wt_sp2_intA) #Both NS.


AIC(sz_wt_sp1Amax, sz_wt_sp2A)
#sz_wt_sp1Amax has slightly more support (Tmax_sp_A, PPT_Wt)

lapply(list(sz_wt_sp1Amax, sz_wt_sp2A), summ, vif = TRUE, scale = TRUE)

```
Use model: `sz_wt_sp1Amax` (Tmax_sp_A & PPT_Wt)


*NOTE*: PPT_A in the above models is always NS (except for models with Tmin_sp & Tave_sp)!!!

**More complex models - multiple season/climate parameters:
```{r eval = FALSE}
#Model Check - including multiple temp anomalies!
cor(nemo_df2$Tmin_wt_A, nemo_df2$Tmax_sp_A)
#Winter & Spring T anoms are not that correlated!!!

badmodel <- lm(DOY ~ Tmin_wt_A + Tmax_sp_A + PPT_sp_A + elev_m + long, data = nemo_df2)
summ(badmodel, scale = TRUE, vif = TRUE)
plot(badmodel) #Assumptions met!
```



#### Comparing Models - Anoms  

**Compare supported seasonal models**  

```{r}
#Additive only
AIC(anom_clim4, sz_wt1A, sz_sp1cmaxA, sz_wt_sp1Amax)
#Most support for Spring Tmax_A model (PPT NS)


#StepAIC model & evaluation
sz_comb_mAICA <- lm(DOY ~ Tmin_wt_A + Tmax_sp_A + PPT_wt_A + PPT_sp_A + elev_m + long + year, data = nemo_df2)
stepAIC(sz_comb_mAICA)
#Additive: Prefers T_sp & PPT_sp the most!
#See above --- using multiple season*climate paramters^^^
```



**Plots** - Only additive models included
```{r warning = FALSE, message = FALSE, echo = FALSE}
#Scaling = Standardize & Center Estimates to make comparisons

#Just Seasonal Variables
plot_summs(sz_wt1A, sz_sp1cmaxA, sz_wt_sp1Amax, model.names = c("Winter", "Spring", "Wt_T & Sp_PPT"), coefs = c("Tmin_wt_A", "Tmax_sp_A", "PPT_wt_A", "PPT_sp_A"), inner_ci_level = 0.8, scale = TRUE) +
  theme_bw()#including covariates


#Seasonal & Annual Variables
plot_summs(anom_clim4, sz_wt1A, sz_sp1cmaxA, sz_wt_sp1Amax, model.names = c("MAT/P", "Winter", "Spring", "Wt_T & Sp_PPT"), coefs = c("MAT_A", "MAP_A", "Tmin_wt_A", "Tmax_sp_A", "PPT_wt_A", "PPT_sp_A"), inner_ci_level = 0.8, scale = TRUE) +
  theme_bw()

#Without mixed-season model
plot_summs(anom_clim4, sz_wt1A, sz_sp1cmaxA, model.names = c("MAT/P", "Winter", "Spring"), coefs = c("MAT_A", "MAP_A", "Tmin_wt_A", "Tmax_sp_A", "PPT_wt_A", "PPT_sp_A"), inner_ci_level = 0.8, scale = TRUE) +
  theme_bw() #Tmax_sp

ggsave(here::here("analyses", "figs1", "plot_summs_Anom_wt_sp_A(Tmax_sp).png"), height = 4, width = 6)

plot_summs(anom_clim4, sz_wt1A, sz_sp1A, model.names = c("MAT/P", "Winter", "Spring"), coefs = c("MAT_A", "MAP_A", "Tmin_wt_A", "Tmin_sp_A", "PPT_wt_A", "PPT_sp_A"), inner_ci_level = 0.8, scale = TRUE) +
  theme_bw() #Tmin_sp

ggsave(here::here("analyses", "figs1", "plot_summs_Anom_wt_sp_A(Tmin_sp).png"), height = 4, width = 6)

#Both Tmin and Tmax spring models:
#plot_summs(anom_clim4, sz_wt1A, sz_sp1A, sz_sp1cmaxA, model.names = c("MAT/P", "Winter", "Spring"), coefs = c("MAT_A", "MAP_A", "Tmin_wt_A", "Tmin_sp_A", "Tmax_sp_A", "PPT_wt_A", "PPT_sp_A"), inner_ci_level = 0.8, scale = TRUE) +
#  theme_bw() #Tmin_sp


#ggsave(here::here("analyses", "figs1", "plot_summs_An_wt_sp_A.png"), height = 4, width = 6)

```


**Compare** Long-term and anomalies sensitivies (separate models)

```{r warning = FALSE, eval = FALSE}
plot_summs(anom_clim4, ann_clim4, model.names = c("MAT/P_100Y", "MAT/P_A"), coefs = c("MAT_100Y", "MAT_A", "MAP_100Y", "MAP_A"), inner_ci_level = 0.8, scale = TRUE) +
  theme_bw()

ggsave(here::here("analyses", "figs1", "plot_summs_MAT-P_Anomx100Y.png"), height = 4, width = 6)

plot_summs(sz_wt1c, sz_wt1A, model.names = c("Winter_100Y", "Winter_A"), coefs = c("Tmin_wt_100Y", "Tmin_wt_A", "PPT_wt_100Y", "PPT_wt_A"), inner_ci_level = 0.8, scale = TRUE) +
  theme_bw() #Winter
ggsave(here::here("analyses", "figs1", "plot_summs_Wt_Anomx100Y.png"), height = 4, width = 6)

plot_summs(sz_sp1c, sz_sp1cmaxA, model.names = c("Spring_100Y", "Spring_A"), coefs = c("Tmin_sp_100Y", "Tmax_sp_A", "PPT_sp_100Y", "PPT_sp_A"), inner_ci_level = 0.8, scale = TRUE) +
  theme_bw() #Spring
ggsave(here::here("analyses", "figs1", "plot_summs_Sp_Anomx100Y.png"), height = 4, width = 6)


#plot_summs(sz_wt1c, sz_sp1c, sz_wt1A, sz_sp1cmaxA, model.names = c("Winter_100Y", "Spring_100Y", "Winter_A", "Spring_A"), coefs = c("Tmin_wt_100Y", "Tmin_wt_A", "Tmin_sp_100Y", "Tmax_sp_A", "PPT_wt_100Y", "PPT_wt_A", "PPT_sp_100Y", "PPT_sp_A"), inner_ci_level = 0.8, scale = TRUE) +
#  theme_bw() #Both

```


<br>  






### Seasonal Conditions - Long-term & Anomalies

*NOTE*: MAT/MAP_100Y and Tmin/PPT_100Y (winter/spring) are strongly correlated--control for long-term MAT/MAP instead. [See EDA2.Rmd]

*Clean up this*

**Winter Conditions**

```{r message = FALSE, warning = FALSE}
sz_wt1A2 <- lm(DOY ~ MAT_100Y + MAP_100Y + Tmin_wt_A + PPT_wt_A + elev_m + long + year, data = nemo_df2)
summary(sz_wt1A2)
#visreg(sz_wt1A2, xvar = "PPT_wt_A", xlab = "PPT (winter)", points = list(col = "#404040"))
#visreg(sz_wt1A2, xvar = "Tmin_wt_A", xlab = "Tmin (winter)", points = list(col = "#404040"))


sz_wt1caveA2 <- lm(DOY ~ MAT_100Y + MAP_100Y + Tave_wt_A + PPT_wt_A + elev_m + long + year, data = nemo_df2)
summary(sz_wt1caveA2) 

sz_wt1A_int2 <- lm(DOY ~ MAT_100Y + MAP_100Y + PPT_wt_A*Tmin_wt_A + elev_m + long + year, data = nemo_df2)
summary(sz_wt1A_int2) #NS


AIC(sz_wt1A2, sz_wt1caveA2, sz_wt1A_int2)
#Tmin model has lowest AIC 


lapply(list(sz_wt1A2, sz_wt1caveA2, sz_wt1A_int2), summ, vif = TRUE, scale = TRUE)

```

Use additive model: 


**Spring Conditions**
```{r message = FALSE, warning = FALSE}
sz_sp1A2 <- lm(DOY ~ MAT_100Y + MAP_100Y + Tmin_sp_A + PPT_sp_A + elev_m + long + year, data = nemo_df2)
summary(sz_sp1A2)
#visreg(sz_sp1A2, xvar = "PPT_sp_A", xlab = "PPT (winter)", points = list(col = "#404040"))
#visreg(sz_sp1A2, xvar = "Tmin_sp_A", xlab = "Tmin (winter)", points = list(col = "#404040"))


sz_sp1caveA2 <- lm(DOY ~ MAT_100Y + MAP_100Y + Tave_sp_A + PPT_sp_A + elev_m + long + year, data = nemo_df2)
summary(sz_sp1caveA2) 
sz_sp1cmaxA2 <- lm(DOY ~ MAT_100Y + MAP_100Y + Tmax_sp_A + PPT_sp_A + elev_m + long + year, data = nemo_df2)
summary(sz_sp1cmaxA2) 


sz_sp1A_int2 <- lm(DOY ~ MAT_100Y + MAP_100Y + PPT_sp_A*Tmin_sp_A + elev_m + long + year, data = nemo_df2)
summary(sz_sp1A_int2) #NS, but similar p value as in long-term model
#Int w/ Tmax also NS


AIC(sz_sp1A2, sz_sp1caveA2, sz_sp1cmaxA2, sz_sp1A_int2)
#Tmax model having the most support (followed by Tave) for spring!!!


lapply(list(sz_sp1A2, sz_sp1caveA2, sz_sp1cmaxA2, sz_sp1A_int2), summ, vif = TRUE, scale = TRUE)
#Tmax_sp_A has the largest coeff, followed by Tave_sp_A has larger coefficient than Tmin

```

Use Model: (followed by: )



**Winter x Spring conditions**  
```{r}
#sz_wt_sp1A2 <- lm(DOY ~ MAT_100Y + MAP_100Y + Tmin_sp_A + PPT_wt_A + elev_m + long + year, data = nemo_df2)
#summary(sz_wt_sp1A2)
#sz_wt_sp1Aave <- lm(DOY ~ MAT_100Y + MAP_100Y + Tave_sp_A + PPT_wt_A + elev_m + long + year, data = nemo_df2)
#summary(sz_wt_sp1Aave2)
sz_wt_sp1Amax2 <- lm(DOY ~ MAT_100Y + MAP_100Y + Tmax_sp_A + PPT_wt_A + elev_m + long + year, data = nemo_df2) #use this Tmax_sp, highest R2, lowest AIC of the 3
summary(sz_wt_sp1Amax2)


sz_wt_sp2A2 <- lm(DOY ~ MAT_100Y + MAP_100Y + Tmin_wt_A + PPT_sp_A + elev_m + long + year, data = nemo_df2)#Use this: Tmin_wt, highest R2, lowest AIC
summary(sz_wt_sp2A2)
#sz_wt_sp2Aave2 <- lm(DOY ~ MAT_100Y + MAP_100Y + Tave_wt_A + PPT_sp_A + elev_m + long + year, data = nemo_df2)
#summary(sz_wt_sp2Aave2)
#sz_wt_sp2Amax2 <- lm(DOY ~ MAT_100Y + MAP_100Y + Tmax_wt_A + PPT_sp_A + elev_m + long + year, data = nemo_df2)
#summary(sz_wt_sp2Amax2)


#Interactions
sz_wt_sp1_intA2 <- lm(DOY ~ MAT_100Y + MAP_100Y + Tmin_wt_A + PPT_sp_A + Tmin_wt_A*PPT_sp_A + elev_m + long + year, data = nemo_df2)
#summary(sz_wt_sp1_intA2)
sz_wt_sp2_intA2 <- lm(DOY ~ MAT_100Y + MAP_100Y + Tmax_sp_A + PPT_wt_A + Tmax_sp_A*PPT_wt_A + elev_m + long + year, data = nemo_df2)
#summary(sz_wt_sp2_intA2) #Both NS.


AIC(sz_wt_sp1Amax2, sz_wt_sp2A2)
#sz_wt_sp1Amax has slightly more support (Tmax_sp_A, PPT_Wt)

lapply(list(sz_wt_sp1Amax2, sz_wt_sp2A2), summ, vif = TRUE, scale = TRUE)

```




