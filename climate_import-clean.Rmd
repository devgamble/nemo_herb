---
title: "Importing ClimateNA data"
author: "Devin Gamble"
date: "12/14/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```


```{r echo = FALSE, warning = FALSE, message = FALSE}
library(tidyverse)
library(here)
library(stringr)
```


### Importing Data from climateNA

**Step 1**: Getting the data ready:  
First, we need create a .csv file.  (Note: The current version of ClimateNA only works with PCs). 
In excel, I have saved a standardized form of the dataset as a *.csv file* with only five specific headings:  
<br>  
ID1* = specimen number  
ID2 = collection year  
lat* = latitude  
long* = longitude  
el = elevation (ClimateNA corrects climate data for elevation - make sure elevation is accurate before querying data)  
* = required  
Use a '.' in the columns if ID2 or el are not available  
*Make sure you save the file as a csv file, and that there are no entries (even spaces) outside of the main set of columns and rows.*  

Creating a ClimateNA-compatible csv from a specimen dataframe input:
```{r}
nemo_df <- read_csv(here::here("data_cleaning", "CCH1_scripts_data", "nemo_standardized_err_dist.csv")) %>% 
  mutate(year = format(verbatim_date, "%Y")) #For when 'year' is available from a collection date column


#Create standardized df for Climate NA
nemo_CNA_df <- tibble(nemo_df$specimen_number, nemo_df$year, nemo_df$latitude, nemo_df$longitude, nemo_df$elevation)
colnames(nemo_CNA_df) <- c("ID1", "ID2", "lat", "long", "el")

#Remove all non-numeric characters from `el` column
nemo_CNA_df <- nemo_CNA_df %>% 
  mutate(el = as.numeric(gsub("\\D+", "", el)))

#Correct erroneous elevation at observation 724
nemo_CNA_df$el[724] <- 1076

#Export this compatible df to a csv for input into ClimateNA

write_csv(nemo_CNA_df, here::here("ClimateNA", "nemo_cch1_std2.csv"))

```



<br>  

**Step 2**: Obtaining Climate normals/decadal data  

Open climateNA application. Under the 'Multi-Location' heading, specify which normals you would like to download in the box. Select the input file, using the csv the dat you just standardized. Specify the output file with the name and location of where you would like it. Once you hit `Start`, Climate NA will download the type of normals you specified and append them as columns to the standardized csv.  
You should then have a new file with normals for all the locations in the original csv.  



<br>  
**Step 3**: Obtaining Annual (or monthly, seasonal) data for all years (Time series data)  

Under the 'Multi-location' heading, select `Historical Time Series`. Below this box, select the desired variables. In this case, I selected Annual variables. Up to the right, select the years for which you would like to download climate data (e.g. 1901 - 2018). Finally, select the standardized input file and the name and location for the output file. Hit `Start TS`.  
(This will probably take some time...)  

You should eventually get a csv file with data for all the specified years, now with a new first column 'Year'. You will now have as many rows as the number of different years multiplied by the number of rows from the original dataset.  

<br>  

*Step 3.5*  

Now, we have annual (or monthly/seasonal) climate data for each specimen for every year in the range. We would like to specify the years which correspond to each specimen.

```{r message = FALSE}
#Simple, standardized data (no climate stuff)
st_data <- read_csv(here("climateNA", "nemo_cch1_std.csv"))


#Import time series data - annual climate for all years for each specimen
allA_data <- read_csv(here("climateNA", "nemo_cch1_std_1901-2018Y.csv"))
```


```{r message = FALSE}
#Create df with annual data for YoC
rename_ftn1 <- function(x, apnd, rang){         
    names_x <- colnames(x)[rang]
    print(paste(names_x, apnd, sep = ""))
} 
#x = dataframe from ClimateNA output, apnd = text to append, rang = range of columns (may vary)

#Only Year of collection annual climate data
YoCA_data <- allA_data %>% 
    filter(ID2 == Year) 
colnames(YoCA_data)[7:29] <- rename_ftn1(allA_data, apnd = "_a*", rang = 7:29) #add "_a*" to YoC variables
```

Now, to create a dataframe with just the climate normals  
```{r message = FALSE, eval = FALSE}

norm1 <- read_csv(here("climateNA", "nemo_cch1_std_Normal_1951_1980Y.csv"))
colnames(norm1)[6:28] <-  rename_ftn1(norm1, "_51-80", 6:28)


norm2 <- read_csv(here("climateNA", "nemo_cch1_std_Normal_1981_2010Y.csv"))
colnames(norm2)[6:28] <-  rename_ftn1(norm2, "_81-10", 6:28)

#Df with both sets of normals
norms_df <- merge (norm1, norm2)


#DF with normals & annual YoC data
YoC_norms <- merge(norms_df, YoCA_data, all.x = TRUE)
#Rows missing from YoCA. Difference of 63: 54 rows have date before 1901, 9 rows where ID2 = NA (Year missing)

#Save a csv of the combined YoC annual and climate normals 
write_csv(YoC_norms, here("climateNA", "YoC_A_norms51-10.csv"))
```



### Cleaning the Data from ClimateNA  

(Decide on what rows to remove, what variables to keep...)
Combine both dataframes or leave separate?  

